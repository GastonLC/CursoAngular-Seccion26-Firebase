name: Construir, Subir a Docker Hub y Desplegar

on:
  push:
    branches:
      - main
      - develop

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout del código fuente
      uses: actions/checkout@v2
      
    - name: Login Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USER }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Construir y Subir imagen a Docker Hub
      uses: docker/build-push-action@v2
      with:
        context: .
        push: true
        tags:  gastonlc/angularapp:1.0.0-Actions
        file: Dockerfile

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout del código fuente
      uses: actions/checkout@v2

    - name: Configurar Kubectl
      run: |
        kubectl config set-cluster ModeloDevops-AKS-Reader --server=https://modelodevops-aks-dns-b137e13a.hcp.westeurope.azmk8s.io
        kubectl config set-context ModeloDevops-AKS-Reader --cluster=ModeloDevops-AKS-Reader --namespace=mi-goty-namespace
        kubectl config set clusters.ModeloDevops-AKS-Reader.certificate-authority-data ${{ secrets.KUBECTL_CA }}
        kubectl config set-credentials gaston --token=${{ secrets.KUBECTL_TOKEN }}
        kubectl config set-context ModeloDevops-AKS-Reader --user=gaston
        kubectl config use-context ModeloDevops-AKS-Reader
        kubectl delete secret goty-tls-secret -n mi-goty-namespace
        kubectl apply -k kustomize

        echo MIIDMTCCAhmgAwIBAgIUSXlPMaMiEyqDT3OeCH8NRL4O1lUwDQYJKoZIhvcNAQELBQAwKDELMAkGA1UEBhMCQ0wxGTAXBgNVBAMMEGdvdHlfY29tbW9uX25hbWUwHhcNMjMwNTMxMjAyMDEzWhcNMjQwNTMwMjAyMDEzWjAoMQswCQYDVQQGEwJDTDEZMBcGA1UEAwwQZ290eV9jb21tb25fbmFtZTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAK8WAoQp0gE2a/VHNPD/S6MoRn5PneI+m+Qj/Zn8kADsMBDDSTstDzAF58hQTNfiZIQBceDVYmZZlBstOHagFB/sLdMzKGtJruDiPs1SGIfdsfzfEvMSUpoOYoi6rnrRg67dGSPGXrwXQIV2EgDuRaqy7FSLKJEn5DnN9Ijgv0kqhPNUr2RKzm9okRflZdnF0ZOIDtx/VmBhYdaip7BUWRtFRsVpCce2UdG2Ai4F0tQmfBmD7ibio7P1zqd8KqXvdF6rr2qTUtu2411k9WqQAu7kVPRynoYTTLCqSgXme7a7O0HN2ZC6YjAyt5AsuLgI08aXZZRhb/TBhU2XMynA0xECAwEAAaNTMFEwHQYDVR0OBBYEFCfSXRUs+wsTOtv57HH7jkHQpJGpMB8GA1UdIwQYMBaAFCfSXRUs+wsTOtv57HH7jkHQpJGp MA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAKFmNnktq8qAwiXHJNNRqQNKavO/kVuTyIxXJtEZtVI6AXozXP7MwNwwXUMqK4bjq/3R7IcsZXcOK6Jili4bP0rcHEYYqhPhHOle1p4U6gDQG87YX8yNeQwNs8BPclfO4ZPAs7BamJ5uNVVP8G2PrurhLc+RIvHglzsUnuW2V15x5Be1Hcb59hE+9ILzPQsPAA7h4WcFWSB2pXTu TsaLv5Lh8KffQrEM5Ygz+i0ZCfH//RV1DxLA2OQhKjtWUS+R4P560mqc4vimmDO6BC/g5CH3Eq+08hSEcjHx9jWwWsHYkSFmpi9ppyoYY7NzuIKxEUbWinnZA72DS85T5SRehHU= | base64 -w0