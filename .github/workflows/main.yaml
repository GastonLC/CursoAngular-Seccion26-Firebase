name: Construir, Subir a Docker Hub y Desplegar

on:
  push:
    branches:
      - main
      - develop

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout del código fuente
      uses: actions/checkout@v2
      
    - name: Login Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USER }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Construir y Subir imagen a Docker Hub
      uses: docker/build-push-action@v2
      with:
        context: .
        push: true
        tags:  gastonlc/angularapp:1.0.0-Actions
        file: Dockerfile

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout del código fuente
      uses: actions/checkout@v2

    - name: Configurar Kubectl
      run: |
        kubectl config set-cluster ModeloDevops-AKS-Reader --server=https://modelodevops-aks-dns-b137e13a.hcp.westeurope.azmk8s.io
        kubectl config set-context ModeloDevops-AKS-Reader --cluster=ModeloDevops-AKS-Reader --namespace=mi-goty-namespace
        kubectl config set clusters.ModeloDevops-AKS-Reader.certificate-authority-data ${{ secrets.KUBECTL_CA }}
        kubectl config set-credentials gaston --token=${{ secrets.KUBECTL_TOKEN }}
        kubectl config set-context ModeloDevops-AKS-Reader --user=gaston
        kubectl config use-context ModeloDevops-AKS-Reader
        kubectl delete secret goty-tls-secret -n mi-goty-namespace
        kubectl apply -k kustomize

        echo MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCvFgKEKdIBNmv1RzTw/0ujKEZ+T53iPpvkI/2Z/JAA7DAQw0k7LQ8wBefIUEzX4mSEAXHg1WJmWZQb LTh2oBQf7C3TMyhrSa7g4j7NUhiH3bH83xLzElKaDmKIuq560YOu3Rkjxl68F0CFdhIA7kWqsuxUiyiRJ+Q5zfSI4L9JKoTzVK9kSs5vaJEX5WXZxdGTiA7cf1ZgYWHWoqewVFkbRUbFaQnHtlHRtgIuBdLUJnwZg+4m4qOz9c6nfCql73Req69qk1LbtuNd ZPVqkALu5FT0cp6GE0ywqkoF5nu2uztBzdmQumIwMreQLLi4CNPGl2WUYW/0wYVNlzMpwNMRAgMBAAECggEADSTzXZwZvbXDh0xoIpTTLY9D/46XNUy3ymBgIe11AcS5jqcCk+4IxY7j8EUEoXGuU/GB0zwuoRPZJR/3ebYAQy2peqezQWuGNMoRDSJvk5+mqziaEeQoJ5QSr94hl2t5EQ/2dIBoTOmkxYA9AmBHaNtgfhZc0ZnAYUCSut+Lxmb9fR0IkbMqEdu3USKE6Hz27KVUIdz1ibC7G/Gcfo8GcTKPebVEv3uNCApepeWn3MQIgUt7Tb/aAytz1h1/iUZaTeoyBB0utAxZ8CgtPvqKk9u1TjWIQd+RsR1WN2hYiiaEu3Am3q5Rj1fV1nL3oUdlkMFf1tFkeMP7vKzV+hlnSwKBgQDXvEIGZWJ6KOsWsFf+VZvEyL7R2x9DsFYX/tA3/TDCEw3HwxF8eGP4asktR21sl0J9tlztdrXBkSXGposypN66t6SijYV6Yyf1uIq1GgjRHnac2zBzW+S6CnX3aRUPGq5ZRcJANuT/XkyHZxKn0dNfNuKRn8X8cRIiMxLEHZEuLwKBgQDPw4qD+T6pUHxy/24plTS7O3ZxGDEIA3EWiUDhq8k0wP74dm6r/s7pbPNHaHszkDQfqPQIYcwl/+AVKK5dpia9pRuLOK57Ppun6TSb4cD3p0cTxvaq4YNuyj1pNnViIsW5tZHMVGLuJtnnjSx10SvNGb+76YMx16vioTEXn10CvwKBgD1x5zQ/KB83DE44B7fu1iDkNEU9LdhvnvXSo6duu7ZrCt+8lXxo JcEZWRdGYsotAskfabRQvU/WcXX09WyFPNLdf0y1FjFXkIgR+Z+/PIejL5FZdKFGqQy78gF3soHMzZ+rmLoFaI+7YfymxM97mcJitYFYimFuKwYGme+1pCYNAoGBAKASWx01ImcW4NtFG14kW/1JYgbeiaBP7ohbdUapsRrY+1j4/mm7pzVHQOSqhgmDN/WQmXv/xWcdjksfDcCPa9e/ZspMAHpqEUk8LtFPDPqBwgxlxdSAbWAlp0zxrVzPx6E+WDeiaJpuCoMRTMj1QJcEGKoxzmfPb9nrMUSu/t1HAoGBAI4yJeoXIUX5LnMJrT1IMeBBLQ900KebY78ye80xmqfsXRVuoWRRI23T9EL4QBBXLP3szDJi81QbWDm/oKxJtdgqRwpyUSruZDp9KUMKwrEs0bwZ90dt/h6E+ANbQ6BOR5mg8RfCpf5ARlfl6YiXLm+5IbH6bN1Jmy6kjQqS5F5E | base64 -w0